{% extends 'base.html' %}

{% block title %}{{ item.name }} - {{ SITE_NAME }}{% endblock %}

{% block extra_css %}
<style>
    .menu-item-image {
        max-height: 400px;
        object-fit: cover;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .menu-item-price {
        font-size: 2rem;
        font-weight: bold;
        color: #28a745;
    }
    
    .menu-item-quantity {
        font-size: 1.1rem;
        color: #6c757d;
    }
    
    .menu-item-quantity.low {
        color: #dc3545;
    }
    
    .quantity-control {
        width: 150px;
    }
    
    .quantity-control .btn {
        width: 40px;
        height: 40px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .quantity-control input {
        width: 70px;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    
    .add-to-cart-btn {
        width: 100%;
        max-width: 300px;
    }
    
    .back-to-menu {
        color: #6c757d;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .back-to-menu:hover {
        color: #007bff;
    }
    
    .back-to-menu i {
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <a href="{% url 'menu:menu_list' %}" class="back-to-menu">
        <i class="bi bi-arrow-left"></i> Вернуться к меню
    </a>
    
    <div class="row">
        <div class="col-md-6">
            <img src="{{ item.photo.url }}" class="img-fluid menu-item-image" alt="{{ item.name }}">
        </div>
        <div class="col-md-6">
            <h1 class="mb-3">{{ item.name }}</h1>
            <p class="lead mb-4">{{ item.description }}</p>
            
            <div class="d-flex align-items-center mb-4">
                <span class="menu-item-price me-4">{{ item.price|default:"0"|floatformat:2 }} {{ CURRENCY_SYMBOL }}</span>
                <span class="menu-item-quantity {% if item.quantity < 5 %}low{% endif %}">
                    {% if item.quantity > 0 %}
                        В наличии: {{ item.quantity }}
                    {% else %}
                        Нет в наличии
                    {% endif %}
                </span>
            </div>
            
            {% if item.quantity > 0 %}
                <div class="d-flex align-items-center mb-4">
                    <div class="quantity-control d-flex align-items-center me-3">
                        <button class="btn btn-outline-secondary decrease-quantity" type="button">-</button>
                        <input type="number" class="form-control mx-2 quantity-input" value="1" min="1" max="{{ item.quantity }}">
                        <button class="btn btn-outline-secondary increase-quantity" type="button">+</button>
                    </div>
                    <button class="btn btn-primary add-to-cart-btn" data-item-id="{{ item.id }}">
                        <i class="bi bi-cart-plus"></i> Добавить в корзину
                    </button>
                </div>
            {% else %}
                <div class="alert alert-warning">
                    К сожалению, данный товар временно недоступен.
                </div>
            {% endif %}
            
            <div class="mt-4">
                <h5>Категория</h5>
                <p>{{ item.category.name }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const quantityInput = $('.quantity-input');
    const decreaseBtn = $('.decrease-quantity');
    const increaseBtn = $('.increase-quantity');
    const maxQuantity = {{ item.quantity }};
    
    // Обработка изменения количества
    decreaseBtn.click(function() {
        let value = parseInt(quantityInput.val());
        if (value > 1) {
            quantityInput.val(value - 1);
        }
    });
    
    increaseBtn.click(function() {
        let value = parseInt(quantityInput.val());
        if (value < maxQuantity) {
            quantityInput.val(value + 1);
        }
    });
    
    // Валидация ввода
    quantityInput.on('input', function() {
        let value = parseInt($(this).val());
        if (isNaN(value) || value < 1) {
            $(this).val(1);
        } else if (value > maxQuantity) {
            $(this).val(maxQuantity);
        }
    });
    
    // Добавление в корзину
    $('.add-to-cart-btn').click(function() {
        const itemId = $(this).data('item-id');
        const quantity = parseInt(quantityInput.val());
        
        $.post('{% url "orders:add_to_cart" %}', {
            item_id: itemId,
            quantity: quantity,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        })
        .done(function(response) {
            if (response.status === 'success') {
                // Обновляем счетчик корзины
                $('.cart-count').text(response.cart_count);
                
                // Показываем уведомление
                const toast = `
                    <div class="toast-container position-fixed bottom-0 end-0 p-3">
                        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="toast-header">
                                <strong class="me-auto">Уведомление</strong>
                                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                            <div class="toast-body">
                                ${response.message}
                            </div>
                        </div>
                    </div>
                `;
                
                $('body').append(toast);
                $('.toast').toast({ delay: 3000 }).toast('show');
                
                // Удаляем уведомление после скрытия
                $('.toast').on('hidden.bs.toast', function() {
                    $(this).parent().remove();
                });
            }
        });
    });
});
</script>
{% endblock %} 